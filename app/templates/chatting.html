<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PrivTalk Chat</title>
  <link rel="stylesheet" href="/static/chat_style.css" />
  <link rel="icon" type="image/png" href="/static/icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>
</head>
<body>
  <div class="chat-wrapper">
    <h2 class="chat-header">üí¨ Chatting with: <span>{{ other_user }}</span></h2>
    <div class="chat-box" id="chatBox">
      <div class="message friend">
        <div class="bubble">
          <div class="text">üëã Welcome to PrivTalk!</div>
          <div class="timestamp">Just now</div>
        </div>
      </div>
    </div>
    <div id="typingIndicator" class="typing-indicator"></div>

    <div class="chat-controls">
      <button class="emoji-button" id="emojiBtn">üòÄ</button>
      <label for="fileInput">üìé</label>
      <input type="file" id="fileInput" accept="image/*,video/*" />
      <button id="recordBtn">üé§</button>
      <input type="text" id="messageInput" placeholder="Type your message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const fileInput = document.getElementById("fileInput");
    const recordBtn = document.getElementById("recordBtn");
    const typingIndicator = document.getElementById("typingIndicator");

    const token = new URLSearchParams(window.location.search).get("token");
    const socket = new WebSocket(`ws://localhost:8000/ws/chat/${token}`);

    // Typing indicator
    messageInput.addEventListener("input", () => {
      socket.send("__typing__");
    });

    // Seen update on window focus
    window.addEventListener("focus", () => {
      socket.send("__seen__");
    });

    socket.onmessage = function (event) {
      const data = event.data;

      if (data === "__typing__") {
        typingIndicator.innerText = "Typing...";
        setTimeout(() => { typingIndicator.innerText = ""; }, 2000);
        return;
      }

      const timestamp = new Date().toLocaleTimeString();
      const msgDiv = document.createElement("div");
      msgDiv.className = "message friend";
      msgDiv.innerHTML = `
        <div class="bubble">
          <div class="text">${data}</div>
          <div class="timestamp">${timestamp} <span class="status">‚úÖ‚úÖ</span></div>
        </div>`;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Send back delivery confirmation
      // Optional if you track with message IDs
      // socket.send("__delivered__:" + messageId);
    };

    function sendMessage() {
      const msg = messageInput.value.trim();
      if (!msg) return;

      const timestamp = new Date().toLocaleTimeString();
      const msgDiv = document.createElement("div");
      msgDiv.className = "message user";
      msgDiv.innerHTML = `
        <div class="bubble">
          <div class="text">${msg}</div>
          <div class="timestamp">${timestamp} <span class="status">‚úÖ</span></div>
        </div>`;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      socket.send(msg);
      messageInput.value = "";
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append("file", file);
      const res = await fetch("/upload", { method: "POST", body: formData });
      const data = await res.json();
      return data.url;
    }

    fileInput.addEventListener("change", async function () {
      const file = fileInput.files[0];
      if (!file) return;
      const url = await uploadFile(file);
      const timestamp = new Date().toLocaleTimeString();
      const msgDiv = document.createElement("div");
      msgDiv.className = "message user";

      if (file.type.startsWith("image")) {
        msgDiv.innerHTML = `<div class="bubble">
            <img src="${url}" style="max-width: 200px; border-radius: 10px;"><div class="timestamp">${timestamp}</div>
          </div>`;
      } else if (file.type.startsWith("video")) {
        msgDiv.innerHTML = `<div class="bubble">
            <video src="${url}" controls style="max-width: 200px; border-radius: 10px;"></video><div class="timestamp">${timestamp}</div>
          </div>`;
      }

      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      socket.send(`[Attachment] ${url}`);
    });

    // Emoji picker
    const emojiBtn = document.getElementById("emojiBtn");
    const picker = new EmojiButton();
    picker.on("emoji", emoji => {
      messageInput.value += emoji;
      messageInput.focus();
    });
    emojiBtn.addEventListener("click", () => picker.togglePicker(emojiBtn));

    document.addEventListener("DOMContentLoaded", () => {
      const recordBtn = document.getElementById("recordBtn");
      let mediaRecorder;
      let audioChunks = [];

    recordBtn.addEventListener("click", async () => {
      try {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const file = new File([audioBlob], "voice.webm", { type: "audio/webm" });
            const audioUrl = await uploadFile(file);
            const timestamp = new Date().toLocaleTimeString();

            const msgDiv = document.createElement("div");
            msgDiv.className = "message user";
            msgDiv.innerHTML = `<div class="bubble">
                <audio controls src="${audioUrl}" style="width: 200px;"></audio>
                <div class="timestamp">${timestamp}</div>
              </div>`;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            socket.send(`[Voice Message] ${audioUrl}`);
            audioChunks = [];
          };

          mediaRecorder.start();
          recordBtn.innerText = "‚èπÔ∏è";
          setTimeout(() => {
            mediaRecorder.stop();
            recordBtn.innerText = "üé§";
          }, 5000);
        }
      } catch (err) {
        alert("üéôÔ∏è Microphone access denied or unsupported.");
        console.error(err);
      }
    });
  });

  </script>
</body>
</html>
