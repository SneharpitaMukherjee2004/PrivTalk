<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Room | PrivTalk</title>
  <link rel="stylesheet" href="/static/chat_style.css" />
  <link rel="icon" type="image/png" href="/static/icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">ğŸ” Private Chat Room</div>

    <div class="chat-header">
      <h2>Welcome to Room</h2>
      <div class="roomdata">
        <div class="room-header-line">
          <div>
            <p class="room-id-label">
              Room ID: <span id="room_id_val">{{ room_id }}</span>
            </p>
          </div>
          {% if qr_url %}
          <div class="qr-container">
            <img id="meetingQR_img" src="{{ qr_url }}" alt="Room QR Code" class="qr-img"/>
            <a id="meetingQR_download" href="{{ qr_url }}" download="meeting_qr.png" class="qr-download">
              Download QR
            </a>
          </div>
          {% endif %}
        </div>
        <button class="terminateButton">Terminate Room</button>
      </div>
    </div>

    <div id="chatBox" class="chat-box">
      
    </div>
    <div id="typing-indicator" class="typing-indicator" style="display:none; color:green; font-weight:bold;">typing...</div>

    <div class="chat-controls">
      <button id="emoji-btn">ğŸ˜Š</button>
      <input type="file" id="fileInput" style="display:none;" />
      <button id="fileBtn">ğŸ“</button>
      <button id="recordBtn">ğŸ¤</button>
      <input type="text" id="messageInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const emojiBtn = document.getElementById("emoji-btn");
    const fileBtn = document.getElementById("fileBtn");
    const fileInput = document.getElementById("fileInput");
    const recordBtn = document.getElementById("recordBtn");
    let typingTimeout, mediaRecorder, audioChunks = [];

    const chatToken = new URLSearchParams(window.location.search).get("chat_token");
    const roomId = new URLSearchParams(window.location.search).get("room_id");
    const email = "{{ email }}";
    const username = "{{ username }}";
    const token = "{{ token }}";
    const socket = new WebSocket(`ws://localhost:8000/ws/chat/${roomId}?chat_token=${chatToken}`);
    const terminateBtn = document.querySelector(".terminateButton");

    terminateBtn.addEventListener("click", async () => {
    // Step 1: Notify peer via WebSocket
    socket.send(JSON.stringify({ type: "terminate" }));

    // Step 2: Call backend to delete room and QR
    const roomId = document.getElementById("room_id_val").textContent;
    const formData = new FormData();
    formData.append("room_id", roomId);

    await fetch("/terminate-room", {
      method: "POST",
      body: formData,
    });

    // Step 3: Redirect the host
    window.location.href = `/profile?email=${encodeURIComponent(email)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}`;
  });
  socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      
      if (data.type === "terminate") {
        alert("The other user has left the room.");
        setTimeout(() => {
          window.location.href = `/profile?email=${encodeURIComponent(email)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}`},1000);
        return;
      }

      if (data.type === "chat") {
        displayMessage(data.msg, "friend", data.status);
        socket.send(JSON.stringify({ type: "seen" }));
      } else if (data.type === "file") {
        displayFileMessage(data.filename, data.url, "friend");
      } else if (data.type === "audio") {
        displayAudioMessage(data.url, "friend");
        socket.send(JSON.stringify({ type: "seen" }));
      } else if (data.type === "typing") {
        showTypingIndicator();
      } else if (data.type === "start_recording") {
        showRecordingIndicator(true);
      } else if (data.type === "stop_recording") {
        showRecordingIndicator(false);
      } else if (data.type === "seen") {
        updateLastMessageStatus("seen");
      }
    };

    sendBtn.onclick = sendMessage;

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
      else socket.send(JSON.stringify({ type: "typing" }));
    });

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;

      socket.send(JSON.stringify({ type: "chat", msg: msg, status: "sent" }));
      displayMessage(msg, "user", "sent");
      input.value = "";
    }

    function displayMessage(msg, sender, status) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${sender}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerText = msg;

      if (sender === "user") {
        const tick = document.createElement("span");
        tick.className = "message-status " + (status === "seen" ? "status-seen" : "status-sent");
        tick.setAttribute("data-status", status);
        bubble.appendChild(tick);
      }

      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.innerText = new Date().toLocaleTimeString();

      wrapper.appendChild(bubble);
      wrapper.appendChild(timestamp);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function displayAudioMessage(url, sender, status = "") {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${sender}`;

      const bubble = document.createElement("div");
      bubble.className = "bubble voice-msg-container";

      const audio = document.createElement("audio");
      audio.src = url;
      audio.controls = true;
      audio.className = "voice-player";
      bubble.appendChild(audio);

      if (sender === "user" && status) {
        const tick = document.createElement("span");
        tick.className = "message-status " + (status === "seen" ? "status-seen" : "status-sent");
        bubble.appendChild(tick);
      }

      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.innerText = new Date().toLocaleTimeString();

      wrapper.appendChild(bubble);
      wrapper.appendChild(timestamp);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTypingIndicator() {
      const ti = document.getElementById("typing-indicator");
      ti.style.display = "block";
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => { ti.style.display = "none"; }, 1500);
    }

    function showRecordingIndicator(isRecording) {
      const ti = document.getElementById("typing-indicator");
      if (isRecording) {
        ti.innerText = "recording...";
        ti.style.display = "block";
      } else {
        ti.style.display = "none";
        ti.innerText = "typing...";
      }
    }


    function updateLastMessageStatus(status) {
      const ticks = document.querySelectorAll(".message.user .message-status");
      if (ticks.length > 0) {
        const lastTick = ticks[ticks.length - 1];
        lastTick.className = "message-status status-" + status;
        lastTick.setAttribute("data-status", status);
      }
    }


    // âœ… File Upload
    fileBtn.onclick = () => fileInput.click();
    fileInput.onchange = async () => {
      const file = fileInput.files[0];
      const roomId = document.getElementById("room_id_val").textContent;
      
      if (!file) return;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("meeting_id",roomId);
      const response = await fetch("/upload", { method: "POST", body: formData });
      const result = await response.json();

      socket.send(JSON.stringify({ type: "file", filename: file.name, url: result.url }));
      displayFileMessage(file.name, result.url, "user");
    };

    function displayFileMessage(name, url, sender) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${sender}`;
      const link = document.createElement("a");
      link.href = url;
      link.target = "_blank";
      link.innerText = `ğŸ“ ${name}`;
      wrapper.appendChild(link);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // âœ… Audio
    recordBtn.onclick = async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        socket.send(JSON.stringify({ type: "start_recording" }));
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          socket.send(JSON.stringify({ type: "stop_recording" }));
          const blob = new Blob(audioChunks, { type: "audio/webm" });
          const formData = new FormData();
          formData.append("file", blob, "voice.webm");
          const roomId = document.getElementById("room_id_val").textContent;

          formData.append("meeting_id",roomId);

          const res = await fetch("/upload", { method: "POST", body: formData });
          const data = await res.json();

          socket.send(JSON.stringify({ type: "audio", url: data.url }));
          displayAudioMessage(data.url, "user", "sent");
        };
        mediaRecorder.start();
        recordBtn.innerText = "â¹ Stop";
      } else {
        mediaRecorder.stop();
        recordBtn.innerText = "ğŸ¤";
      }
    };

    // âœ… Emoji Picker
    const picker = new EmojiButton();
    emojiBtn.addEventListener("click", () => {
      picker.togglePicker(emojiBtn);
    });
    picker.on("emoji", emoji => {
      input.value += emoji;
      input.focus();
    });
  </script>
</body>
</html>
