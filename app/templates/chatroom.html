<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Room | PrivTalk</title>
  <link rel="stylesheet" href="/static/chat_style.css" />
  <link rel="icon" type="image/png" href="/static/icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>

</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">üîê Private Chat Room</div>
    <div class="chat-header">
    <h2>Welcome to Room</h2>
<div class='roomdata' style=" display: flex; flex-direction: column;  align-items: flex-start;    margin-top: 20px;">
  <div class="room-header-line" style="  display: flex;justify-content: space-between;align-items: center;  width: 95%;
    max-width: 750px;
    gap: 2px;
    flex-wrap: wrap">
    <div>
      <p class="room-id-label" style="font-weight: bold;
    font-size: 18px;
    color: #333;">Room ID:
    <text id="room_id_val" style="word-break: break-all;font-size: 16px;color: #1ab10d;">{{ room_id }}</text>
  </p>
    </div>
    {% if qr_url %}
    <div class="qr-container" style=" display: flex; flex-direction: row; align-items: center;  margin: 5px;  padding:10px;justify-content: space-between; gap:6px;">
      <img id="meetingQR_img" src="{{ qr_url }}" alt="Room QR Code" style="max-width: 100px; margin:10px; border:solid black 1px;"/>
      <a id="meetingQR_download" href="{{ qr_url }}" download="meeting_qr.png" style="padding:5px; margin:10px; margin-right:20px; ">
      Download Chatroom QR 
    </a>
    
    </div>
    {% endif %}
  </div>
  <button class="terminateButton" style="  background-color: red;
    color: #ccc;
    padding: auto;
    margin: 10px;"> Terminate Room</button>
</div>
</div>

    <div id="chatBox" class="chat-box"></div>

    <div class="chat-controls">
      <button id="emoji-btn">üòä</button>
      <input type="text" id="messageInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    // üîç Extract query parameters from URL
    function getQueryParam(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    const chatToken = getQueryParam("chat_token");
    const roomId = getQueryParam("room_id");

    if (!chatToken || !roomId) {
      alert("Missing chat credentials. Please login or rejoin the room.");
      window.location.href = "/profile";
    }

    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const embutton = document.querySelector('#emoji-btn');


    const socket = new WebSocket(`ws://localhost:8000/ws/chat/${roomId}?chat_token=${chatToken}`);
    
    socket.onopen = () => {
      console.log("‚úÖ Connected to chat room");
    };

    socket.onmessage = (event) => {
      const message = event.data;
      displayMessage(message, "friend");
    };
    
    sendBtn.onclick = () => {
      const msg = input.value.trim();
      if (!msg) return;
      socket.send(msg);
      displayMessage(msg, "user");
      input.value = "";
    };

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") sendBtn.click();
    });

    function displayMessage(msg, type) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${type}`;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerText = msg;

      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.innerText = new Date().toLocaleTimeString();

      wrapper.appendChild(bubble);
      wrapper.appendChild(timestamp);

      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
