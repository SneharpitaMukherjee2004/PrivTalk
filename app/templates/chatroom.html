<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Room | PrivTalk</title>
  <link rel="stylesheet" href="/static/chat_style.css" />
  <link rel="icon" type="image/png" href="/static/icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>
</head>
<body>
  <div class="chat-wrapper">
    <div class="chat-header">üîê Private Chat Room</div>
    <div class="chat-header">
      <h2>Welcome to Room</h2>
      <div class="roomdata">
        <div class="room-header-line">
          <div>
            <p class="room-id-label">
              Room ID: <span id="room_id_val">{{ room_id }}</span>
            </p>
          </div>
          {% if qr_url %}
          <div class="qr-container">
            <img id="meetingQR_img" src="{{ qr_url }}" alt="Room QR Code" class="qr-img"/>
            <a id="meetingQR_download" href="{{ qr_url }}" download="meeting_qr.png" class="qr-download">
              Download QR
            </a>
          </div>
          {% endif %}
        </div>
        <button class="terminateButton">Terminate Room</button>
      </div>
    </div>

    <div id="chatBox" class="chat-box">
      
    </div>
    <div id="typing-indicator" class="typing-indicator" style="display:none; color:green; font-weight:bold;">typing...</div>

   <div class="chat-controls">
  <div class="anchor" style="position:relative;">
    <button id="toggleBtn" class="icon-btn" title="Emoji">üòÄ</button>

    <div id="panel" class="emoji-panel" role="dialog" aria-label="Emoji picker" style="display:none;">
      <div class="emoji-toolbar">
        <input id="search" type="search" placeholder="Search emoji..." />
        <button id="closePanel" class="icon-btn">‚úï</button>
      </div>

      <div class="recent-row" id="recentRow"></div>
      <div class="emoji-cats" id="cats"></div>
      <div class="emoji-grid" id="grid"></div>
      <div class="note">Click an emoji to insert.</div>
    </div>
    
  <input type="file" id="fileInput" style="display:none;" />
  <button id="fileBtn">üìé</button>
  <button id="recordBtn">üé§</button>
  
</div> <!-- closes chat-controls -->

  <input type="text" id="messageInput" placeholder="Type your message..." />
  <button id="sendBtn">Send</button>
</div>

<style>
.emoji-panel {
  position: absolute;
  top: -258px; 
  left: 194px;
  width: 436px;
  background: #fff;
  border: 1px solid #b1dc14ff;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  border-radius: 10px;
  padding: 10px;
  z-index: 9999;
}
button#closePanel {
    text-align: -webkit-center;
    height: 35px;
    background: black;
    width: 32px;
    padding: 1px;
    margin: 0px;
    border: solid 2px rgb(46 255 0 / 73%);
}
input#search{ border-radius: 10px;
    height: 30px;
    width: 397px;
    text-align: -webkit-center;}
.emoji-cats button, .recent-row button, .emoji-item {
  cursor: pointer;
  margin:1px;
}
button.cat-btn 
{
  background: darkgreen;
  font-style: italic;
}
.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8,1fr);
  gap: 6px;
  max-height: 200px;
  overflow: auto;
}
.emoji-item {
  font-size: 20px;
  text-align: center;
  padding: 6px;
  border-radius: 6px;
}
.emoji-item:hover { background:#f0f0f0; }
</style>



  <script>
    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const emojiBtn = document.getElementById("emoji-btn");
    const fileBtn = document.getElementById("fileBtn");
    const fileInput = document.getElementById("fileInput");
    const recordBtn = document.getElementById("recordBtn");
    let typingTimeout, mediaRecorder, audioChunks = [];

    const chatToken = new URLSearchParams(window.location.search).get("chat_token");
    const roomId = new URLSearchParams(window.location.search).get("room_id");
    const email = "{{ email }}";
    const username = "{{ username }}";
    const token = "{{ token }}";
    const socket = new WebSocket(`ws://localhost:8000/ws/chat/${roomId}?chat_token=${chatToken}`);
    const terminateBtn = document.querySelector(".terminateButton");

    terminateBtn.addEventListener("click", async () => {
    // Step 1: Notify peer via WebSocket
    socket.send(JSON.stringify({ type: "terminate" }));

    // Step 2: Call backend to delete room and QR
    const roomId = document.getElementById("room_id_val").textContent;
    const formData = new FormData();
    formData.append("room_id", roomId);

    await fetch("/terminate-room", {
      method: "POST",
      body: formData,
    });

    // Step 3: Redirect the host
    window.location.href = `/profile?email=${encodeURIComponent(email)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}`;
  });
  socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      
      if (data.type === "terminate") {
        alert("The other user has left the room.");
        setTimeout(() => {
          window.location.href = `/profile?email=${encodeURIComponent(email)}&username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}`},1000);
        return;
      }

      if (data.type === "chat") {
        displayMessage(data.msg, "friend", data.status);
        socket.send(JSON.stringify({ type: "seen" }));
      } else if (data.type === "file") {
        displayFileMessage(data.filename, data.url, "friend");
      } else if (data.type === "audio") {
        displayAudioMessage(data.url, "friend");
        socket.send(JSON.stringify({ type: "seen" }));
      } else if (data.type === "typing") {
        showTypingIndicator();
      } else if (data.type === "start_recording") {
        showRecordingIndicator(true);
      } else if (data.type === "stop_recording") {
        showRecordingIndicator(false);
      } else if (data.type === "seen") {
        updateLastMessageStatus("seen");
      }
    };

    sendBtn.onclick = sendMessage;

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
      else socket.send(JSON.stringify({ type: "typing" }));
    });

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;

      socket.send(JSON.stringify({ type: "chat", msg: msg, status: "sent" }));
      displayMessage(msg, "user", "sent");
      input.value = "";
    }

    function displayMessage(msg, sender, status) {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${sender}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerText = msg;

      if (sender === "user") {
        const tick = document.createElement("span");
        tick.className = "message-status " + (status === "seen" ? "status-seen" : "status-sent");
        tick.setAttribute("data-status", status);
        bubble.appendChild(tick);
      }

      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.innerText = new Date().toLocaleTimeString();

      wrapper.appendChild(bubble);
      wrapper.appendChild(timestamp);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    function displayAudioMessage(url, sender, status = "") {
      const wrapper = document.createElement("div");
      wrapper.className = `message ${sender}`;

      const bubble = document.createElement("div");
      bubble.className = "bubble voice-msg-container";

      const audio = document.createElement("audio");
      audio.src = url;
      audio.controls = true;
      audio.className = "voice-player";
      bubble.appendChild(audio);

      if (sender === "user" && status) {
        const tick = document.createElement("span");
        tick.className = "message-status " + (status === "seen" ? "status-seen" : "status-sent");
        bubble.appendChild(tick);
      }

      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.innerText = new Date().toLocaleTimeString();

      wrapper.appendChild(bubble);
      wrapper.appendChild(timestamp);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTypingIndicator() {
      const ti = document.getElementById("typing-indicator");
      ti.style.display = "block";
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => { ti.style.display = "none"; }, 1500);
    }

    function showRecordingIndicator(isRecording) {
      const ti = document.getElementById("typing-indicator");
      if (isRecording) {
        ti.innerText = "recording...";
        ti.style.display = "block";
      } else {
        ti.style.display = "none";
        ti.innerText = "typing...";
      }
    }


    function updateLastMessageStatus(status) {
      const ticks = document.querySelectorAll(".message.user .message-status");
      if (ticks.length > 0) {
        const lastTick = ticks[ticks.length - 1];
        lastTick.className = "message-status status-" + status;
        lastTick.setAttribute("data-status", status);
      }
    }


    // ‚úÖ File Upload
    fileBtn.onclick = () => fileInput.click();
    fileInput.onchange = async () => {
      const file = fileInput.files[0];
      const roomId = document.getElementById("room_id_val").textContent;
      
      if (!file) return;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("meeting_id",roomId);
      const response = await fetch("/upload", { method: "POST", body: formData });
      const result = await response.json();

      socket.send(JSON.stringify({ type: "file", filename: file.name, url: result.url }));
      displayFileMessage(file.name, result.url, "user");
    };
//MSG DISPLAY 
    function displayFileMessage(name, url, sender) {
    const wrapper = document.createElement("div");
    wrapper.className = `message ${sender}`;

    // Detect file type by extension
    const ext = name.split('.').pop().toLowerCase();

    if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
        // üì∑ Image preview
        const img = document.createElement("img");
        img.src = url;
        img.alt = name;
        img.className = "chat-image";
        wrapper.appendChild(img);

    } else if (["mp4", "webm", "ogg"].includes(ext)) {
        // üé• Video preview
        const video = document.createElement("video");
        video.src = url;
        video.controls = true;
        video.className = "chat-video";
        wrapper.appendChild(video);

    } else if (["mp3", "wav", "ogg", "webm"].includes(ext)) {
        // üéµ Audio player
        const audio = document.createElement("audio");
        audio.src = url;
        audio.controls = true;
        wrapper.appendChild(audio);

    } else if (["pdf"].includes(ext)) {
        // üìÑ PDF inline view
        const iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.className = "chat-pdf";
        wrapper.appendChild(iframe);

    } else {
        // üìé Fallback: show link for other files
        const link = document.createElement("a");
        link.href = url;
        link.target = "_blank";
        link.innerText = `üìé ${name}`;
        wrapper.appendChild(link);
    }

    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
}
    // ‚úÖ Audio
    recordBtn.onclick = async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        socket.send(JSON.stringify({ type: "start_recording" }));
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          socket.send(JSON.stringify({ type: "stop_recording" }));
          const blob = new Blob(audioChunks, { type: "audio/webm" });
          const formData = new FormData();
          formData.append("file", blob, "voice.webm");
          const roomId = document.getElementById("room_id_val").textContent;

          formData.append("meeting_id",roomId);

          const res = await fetch("/upload", { method: "POST", body: formData });
          const data = await res.json();

          socket.send(JSON.stringify({ type: "audio", url: data.url }));
          displayAudioMessage(data.url, "user", "sent");
        };
        mediaRecorder.start();
        recordBtn.innerText = "‚èπ Stop";
      } else {
        mediaRecorder.stop();
        recordBtn.innerText = "üé§";
      }
    };

    // ‚úÖ Emoji Picker
    // ‚úÖ Manual Emoji Picker
const EMOJIS = [
  // ------------- Smileys (30) -------------
  {char:'üòÄ', name:'grinning face', keywords:['happy','smile'], cat:'Smileys'},
  {char:'üòÅ', name:'beaming face', keywords:['happy','smile'], cat:'Smileys'},
  {char:'üòÇ', name:'face with tears of joy', keywords:['funny','lol'], cat:'Smileys'},
  {char:'ü§£', name:'rolling on floor laughing', keywords:['funny','rofl'], cat:'Smileys'},
  {char:'üòÉ', name:'smiling face', keywords:['happy','smile'], cat:'Smileys'},
  {char:'üòÑ', name:'smiling face with open mouth', keywords:['happy','smile'], cat:'Smileys'},
  {char:'üòÖ', name:'smiling with sweat', keywords:['nervous','funny'], cat:'Smileys'},
  {char:'üòÜ', name:'grinning squinting face', keywords:['laugh','funny'], cat:'Smileys'},
  {char:'üòâ', name:'winking face', keywords:['flirt','wink'], cat:'Smileys'},
  {char:'üòä', name:'smiling with eyes', keywords:['happy','blush'], cat:'Smileys'},
  {char:'üòã', name:'face savoring food', keywords:['yummy','food'], cat:'Smileys'},
  {char:'üòé', name:'cool face', keywords:['sunglasses','cool'], cat:'Smileys'},
  {char:'üòç', name:'heart eyes', keywords:['love','heart'], cat:'Smileys'},
  {char:'üòò', name:'face blowing kiss', keywords:['kiss','love'], cat:'Smileys'},
  {char:'üòó', name:'kissing face', keywords:['kiss','love'], cat:'Smileys'},
  {char:'üòô', name:'kissing with smile', keywords:['kiss','happy'], cat:'Smileys'},
  {char:'üòö', name:'kissing eyes closed', keywords:['kiss','love'], cat:'Smileys'},
  {char:'‚ò∫Ô∏è', name:'smiling face', keywords:['blush','happy'], cat:'Smileys'},
  {char:'üôÇ', name:'slightly smiling', keywords:['smile','happy'], cat:'Smileys'},
  {char:'ü§ó', name:'hugging face', keywords:['hug','love'], cat:'Smileys'},
  {char:'ü§©', name:'star-struck', keywords:['amazing','love'], cat:'Smileys'},
  {char:'ü§î', name:'thinking face', keywords:['thinking','question'], cat:'Smileys'},
  {char:'ü§®', name:'raised eyebrow', keywords:['skeptical','question'], cat:'Smileys'},
  {char:'üòê', name:'neutral face', keywords:['meh','neutral'], cat:'Smileys'},
  {char:'üòë', name:'expressionless', keywords:['meh','bored'], cat:'Smileys'},
  {char:'üò∂', name:'face without mouth', keywords:['silent','shy'], cat:'Smileys'},
  {char:'üôÑ', name:'rolling eyes', keywords:['annoyed','bored'], cat:'Smileys'},
  {char:'üòè', name:'smirking', keywords:['smirk','flirt'], cat:'Smileys'},
  {char:'üò£', name:'persevering', keywords:['stress','sad'], cat:'Smileys'},
  {char:'üò•', name:'sad but relieved', keywords:['sad','phew'], cat:'Smileys'},

  // ------------- Gestures (30) -------------
  {char:'üëç', name:'thumbs up', keywords:['ok','like'], cat:'Gestures'},
  {char:'üëé', name:'thumbs down', keywords:['dislike','no'], cat:'Gestures'},
  {char:'üëè', name:'clapping hands', keywords:['clap','applause'], cat:'Gestures'},
  {char:'üôè', name:'folded hands', keywords:['pray','thanks'], cat:'Gestures'},
  {char:'‚úåÔ∏è', name:'victory hand', keywords:['peace','v'], cat:'Gestures'},
  {char:'ü§û', name:'crossed fingers', keywords:['hope','luck'], cat:'Gestures'},
  {char:'ü§ü', name:'love-you gesture', keywords:['rock','love'], cat:'Gestures'},
  {char:'ü§ò', name:'rock on', keywords:['rock','music'], cat:'Gestures'},
  {char:'üëå', name:'ok hand', keywords:['ok','perfect'], cat:'Gestures'},
  {char:'ü§ô', name:'call me hand', keywords:['phone','call'], cat:'Gestures'},
  {char:'üëã', name:'waving hand', keywords:['hi','bye'], cat:'Gestures'},
  {char:'‚úã', name:'raised hand', keywords:['stop','hi'], cat:'Gestures'},
  {char:'ü§ö', name:'raised back of hand', keywords:['stop','hi'], cat:'Gestures'},
  {char:'üñêÔ∏è', name:'hand with fingers splayed', keywords:['hand','hi'], cat:'Gestures'},
  {char:'üññ', name:'vulcan salute', keywords:['spock','live long'], cat:'Gestures'},
  {char:'üí™', name:'flexed biceps', keywords:['strong','muscle'], cat:'Gestures'},
  {char:'üñï', name:'middle finger', keywords:['rude','angry'], cat:'Gestures'},
  {char:'‚úä', name:'raised fist', keywords:['fight','power'], cat:'Gestures'},
  {char:'üëä', name:'fist', keywords:['punch','fight'], cat:'Gestures'},
  {char:'ü§õ', name:'left-facing fist', keywords:['fight','punch'], cat:'Gestures'},
  {char:'ü§ú', name:'right-facing fist', keywords:['fight','punch'], cat:'Gestures'},
  {char:'ü§≤', name:'palms up together', keywords:['beg','please'], cat:'Gestures'},
  {char:'ü§ù', name:'handshake', keywords:['deal','agreement'], cat:'Gestures'},
  {char:'üëê', name:'open hands', keywords:['welcome','open'], cat:'Gestures'},
  {char:'üôå', name:'raising hands', keywords:['yay','celebrate'], cat:'Gestures'},
  {char:'üôè', name:'folded hands', keywords:['pray','thanks'], cat:'Gestures'},
  {char:'ü§è', name:'pinching hand', keywords:['small','tiny'], cat:'Gestures'},
  {char:'ü§ú', name:'punch right', keywords:['fight','punch'], cat:'Gestures'},
  {char:'ü§õ', name:'punch left', keywords:['fight','punch'], cat:'Gestures'},

  // ------------- Symbols (30) -------------
  {char:'‚ù§Ô∏è', name:'red heart', keywords:['love','heart'], cat:'Symbols'},
  {char:'üíî', name:'broken heart', keywords:['sad','heart'], cat:'Symbols'},
  {char:'üíñ', name:'sparkling heart', keywords:['love','heart'], cat:'Symbols'},
  {char:'üíò', name:'heart with arrow', keywords:['love','valentine'], cat:'Symbols'},
  {char:'üíù', name:'heart with ribbon', keywords:['love','gift'], cat:'Symbols'},
  {char:'üíû', name:'revolving hearts', keywords:['love','romance'], cat:'Symbols'},
  {char:'üíï', name:'two hearts', keywords:['love','heart'], cat:'Symbols'},
  {char:'üíü', name:'heart decoration', keywords:['love','heart'], cat:'Symbols'},
  {char:'‚ù£Ô∏è', name:'heart exclamation', keywords:['love','heart'], cat:'Symbols'},
  {char:'üí¢', name:'anger symbol', keywords:['angry','mad'], cat:'Symbols'},
  {char:'üí§', name:'zzz', keywords:['sleep','tired'], cat:'Symbols'},
  {char:'üí®', name:'dash', keywords:['speed','wind'], cat:'Symbols'},
  {char:'üî•', name:'fire', keywords:['hot','lit'], cat:'Symbols'},
  {char:'‚≠ê', name:'star', keywords:['star','favorite'], cat:'Symbols'},
  {char:'üåü', name:'glowing star', keywords:['star','shine'], cat:'Symbols'},
  {char:'‚ú®', name:'sparkles', keywords:['shine','magic'], cat:'Symbols'},
  {char:'‚ö°', name:'high voltage', keywords:['electric','energy'], cat:'Symbols'},
  {char:'‚òÄÔ∏è', name:'sun', keywords:['weather','bright'], cat:'Symbols'},
  {char:'üåô', name:'crescent moon', keywords:['night','moon'], cat:'Symbols'},
  {char:'‚òÅÔ∏è', name:'cloud', keywords:['weather','sky'], cat:'Symbols'},
  {char:'‚ùÑÔ∏è', name:'snowflake', keywords:['cold','winter'], cat:'Symbols'},
  {char:'‚òÇÔ∏è', name:'umbrella', keywords:['rain','weather'], cat:'Symbols'},
  {char:'‚öì', name:'anchor', keywords:['sea','boat'], cat:'Symbols'},
  {char:'‚ôªÔ∏è', name:'recycle', keywords:['eco','environment'], cat:'Symbols'},
  {char:'üíé', name:'gem stone', keywords:['jewel','precious'], cat:'Symbols'},
  {char:'üéµ', name:'musical note', keywords:['music','sound'], cat:'Symbols'},
  {char:'üé∂', name:'musical notes', keywords:['music','sound'], cat:'Symbols'},
  {char:'üéº', name:'musical score', keywords:['music','note'], cat:'Symbols'},
  {char:'‚öΩ', name:'soccer ball', keywords:['sports','football'], cat:'Symbols'},
  {char:'üèÄ', name:'basketball', keywords:['sports','ball'], cat:'Symbols'},
  {char:'üèà', name:'american football', keywords:['sports','ball'], cat:'Symbols'},
  {char:'‚öæ', name:'baseball', keywords:['sports','ball'], cat:'Symbols'},

  // ------------- Food (30) -------------
  {char:'üçé', name:'apple', keywords:['fruit','healthy'], cat:'Food'},
  {char:'üçè', name:'green apple', keywords:['fruit','healthy'], cat:'Food'},
  {char:'üçê', name:'pear', keywords:['fruit','healthy'], cat:'Food'},
  {char:'üçä', name:'orange', keywords:['fruit','citrus'], cat:'Food'},
  {char:'üçã', name:'lemon', keywords:['fruit','citrus'], cat:'Food'},
  {char:'üçå', name:'banana', keywords:['fruit','yellow'], cat:'Food'},
  {char:'üçâ', name:'watermelon', keywords:['fruit','summer'], cat:'Food'},
  {char:'üçá', name:'grapes', keywords:['fruit','purple'], cat:'Food'},
  {char:'üçì', name:'strawberry', keywords:['fruit','red'], cat:'Food'},
  {char:'üçà', name:'melon', keywords:['fruit','green'], cat:'Food'},
  {char:'üçí', name:'cherries', keywords:['fruit','red'], cat:'Food'},
  {char:'üçë', name:'peach', keywords:['fruit','pink'], cat:'Food'},
  {char:'üçç', name:'pineapple', keywords:['fruit','tropical'], cat:'Food'},
  {char:'ü•≠', name:'mango', keywords:['fruit','tropical'], cat:'Food'},
  {char:'ü•ù', name:'kiwi', keywords:['fruit','green'], cat:'Food'},
  {char:'üçÖ', name:'tomato', keywords:['vegetable','red'], cat:'Food'},
  {char:'ü•ë', name:'avocado', keywords:['green','healthy'], cat:'Food'},
  {char:'üçÜ', name:'eggplant', keywords:['vegetable','purple'], cat:'Food'},
  {char:'ü•î', name:'potato', keywords:['vegetable','brown'], cat:'Food'},
  {char:'ü•ï', name:'carrot', keywords:['vegetable','orange'], cat:'Food'},
  {char:'üåΩ', name:'corn', keywords:['vegetable','yellow'], cat:'Food'},
  {char:'üå∂Ô∏è', name:'chili pepper', keywords:['spicy','vegetable'], cat:'Food'},
  {char:'ü•í', name:'cucumber', keywords:['vegetable','green'], cat:'Food'},
  {char:'ü•¨', name:'lettuce', keywords:['vegetable','green'], cat:'Food'},
  {char:'ü•¶', name:'broccoli', keywords:['vegetable','green'], cat:'Food'},
  {char:'üßÑ', name:'garlic', keywords:['food','flavor'], cat:'Food'},
  {char:'üßÖ', name:'onion', keywords:['food','flavor'], cat:'Food'},
  {char:'ü•ú', name:'peanuts', keywords:['nut','snack'], cat:'Food'},
  {char:'üå∞', name:'chestnut', keywords:['nut','snack'], cat:'Food'},

  // ------------- Animals (30) -------------
  {char:'üê∂', name:'dog', keywords:['pet','animal'], cat:'Animals'},
  {char:'üê±', name:'cat', keywords:['pet','animal'], cat:'Animals'},
  {char:'üê≠', name:'mouse', keywords:['pet','animal'], cat:'Animals'},
  {char:'üêπ', name:'hamster', keywords:['pet','animal'], cat:'Animals'},
  {char:'üê∞', name:'rabbit', keywords:['pet','animal'], cat:'Animals'},
  {char:'ü¶ä', name:'fox', keywords:['wild','animal'], cat:'Animals'},
  {char:'üêª', name:'bear', keywords:['wild','animal'], cat:'Animals'},
  {char:'üêº', name:'panda', keywords:['wild','animal'], cat:'Animals'},
  {char:'üê®', name:'koala', keywords:['wild','animal'], cat:'Animals'},
  {char:'üêØ', name:'tiger', keywords:['wild','animal'], cat:'Animals'},
  {char:'ü¶Å', name:'lion', keywords:['wild','animal'], cat:'Animals'},
  {char:'üêÆ', name:'cow', keywords:['farm','animal'], cat:'Animals'},
  {char:'üê∑', name:'pig', keywords:['farm','animal'], cat:'Animals'},
  {char:'üê∏', name:'frog', keywords:['wild','animal'], cat:'Animals'},
  {char:'üêµ', name:'monkey', keywords:['wild','animal'], cat:'Animals'},
  {char:'üôà', name:'see no evil', keywords:['monkey','funny'], cat:'Animals'},
  {char:'üôâ', name:'hear no evil', keywords:['monkey','funny'], cat:'Animals'},
  {char:'üôä', name:'speak no evil', keywords:['monkey','funny'], cat:'Animals'},
  {char:'üêí', name:'monkey', keywords:['wild','animal'], cat:'Animals'},
  {char:'ü¶ç', name:'gorilla', keywords:['wild','animal'], cat:'Animals'},
  {char:'üêî', name:'chicken', keywords:['farm','animal'], cat:'Animals'},
  {char:'üêß', name:'penguin', keywords:['bird','cold'], cat:'Animals'},
  {char:'üê¶', name:'bird', keywords:['fly','animal'], cat:'Animals'},
  {char:'üê§', name:'chick', keywords:['bird','baby'], cat:'Animals'},
  {char:'üê£', name:'hatching chick', keywords:['bird','baby'], cat:'Animals'},
  {char:'üê•', name:'front-facing chick', keywords:['bird','baby'], cat:'Animals'},
  {char:'ü¶Ü', name:'duck', keywords:['bird','farm'], cat:'Animals'},
  {char:'ü¶Ö', name:'eagle', keywords:['bird','wild'], cat:'Animals'},

  // ------------- Travel (30) -------------
  {char:'‚úàÔ∏è', name:'airplane', keywords:['travel','flight'], cat:'Travel'},
  {char:'üöÄ', name:'rocket', keywords:['space','launch'], cat:'Travel'},
  {char:'üöÅ', name:'helicopter', keywords:['travel','air'], cat:'Travel'},
  {char:'üöÇ', name:'train', keywords:['travel','rail'], cat:'Travel'},
  {char:'üöä', name:'tram', keywords:['travel','rail'], cat:'Travel'},
  {char:'üöâ', name:'station', keywords:['train','rail'], cat:'Travel'},
  {char:'üöó', name:'car', keywords:['drive','vehicle'], cat:'Travel'},
  {char:'üöï', name:'taxi', keywords:['ride','vehicle'], cat:'Travel'},
  {char:'üöô', name:'SUV', keywords:['drive','vehicle'], cat:'Travel'},
  {char:'üöå', name:'bus', keywords:['transport','vehicle'], cat:'Travel'},
  {char:'üöé', name:'trolleybus', keywords:['transport','vehicle'], cat:'Travel'},
  {char:'üèéÔ∏è', name:'racing car', keywords:['fast','vehicle'], cat:'Travel'},
  {char:'üöì', name:'police car', keywords:['vehicle','law'], cat:'Travel'},
  {char:'üöë', name:'ambulance', keywords:['vehicle','help'], cat:'Travel'},
  {char:'üöí', name:'fire truck', keywords:['vehicle','help'], cat:'Travel'},
  {char:'üöê', name:'minivan', keywords:['transport','vehicle'], cat:'Travel'},
  {char:'üõª', name:'pickup truck', keywords:['vehicle','drive'], cat:'Travel'},
  {char:'üöö', name:'delivery truck', keywords:['vehicle','work'], cat:'Travel'},
  {char:'üöõ', name:'articulated truck', keywords:['vehicle','work'], cat:'Travel'},
  {char:'üöú', name:'tractor', keywords:['farm','vehicle'], cat:'Travel'},
  {char:'üèçÔ∏è', name:'motorcycle', keywords:['bike','fast'], cat:'Travel'},
  {char:'üõµ', name:'scooter', keywords:['bike','fast'], cat:'Travel'},
  {char:'üõ∫', name:'auto rickshaw', keywords:['vehicle','asia'], cat:'Travel'},
  {char:'üõ∂', name:'canoe', keywords:['boat','water'], cat:'Travel'},
  {char:'‚õµ', name:'sailboat', keywords:['boat','water'], cat:'Travel'},
  {char:'üö§', name:'speedboat', keywords:['boat','fast'], cat:'Travel'},
  {char:'üõ≥Ô∏è', name:'passenger ship', keywords:['boat','travel'], cat:'Travel'},
  {char:'‚õ¥Ô∏è', name:'ferry', keywords:['boat','travel'], cat:'Travel'},
  {char:'üõ•Ô∏è', name:'motorboat', keywords:['boat','water'], cat:'Travel'},
];


let recent = [];
const MAX_RECENT = 8;

const toggleBtn = document.getElementById('toggleBtn');
const panel = document.getElementById('panel');
const grid = document.getElementById('grid');
const search = document.getElementById('search');
const catsEl = document.getElementById('cats');
const recentRow = document.getElementById('recentRow');
const inputEl = document.getElementById('messageInput');

let activeCat = null;

function togglePanel() {
  panel.classList.contains('open') ? closePanelFn() : openPanel();
}

function openPanel() { 
  panel.style.display = 'block';    // show panel
  panel.setAttribute('aria-hidden','false'); 
  search.focus(); 
  renderRecent(); 
}

function closePanelFn() { 
  panel.style.display = 'none';     // hide panel
  panel.setAttribute('aria-hidden','true'); 
}


function renderCats() {
  catsEl.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className='cat-btn active';
  allBtn.textContent='All';
  allBtn.onclick=()=>{activeCat=null; updateCatButtons(); renderGrid();}
  catsEl.appendChild(allBtn);
  Array.from(new Set(EMOJIS.map(e=>e.cat))).forEach(cat=>{
    const btn = document.createElement('button');
    btn.className='cat-btn';
    btn.textContent=cat;
    btn.onclick=()=>{activeCat=cat; updateCatButtons(); renderGrid();}
    catsEl.appendChild(btn);
  });
}

function updateCatButtons(){
  Array.from(catsEl.children).forEach(btn=>{
    btn.classList.toggle('active', (activeCat===null && btn.textContent==='All') || btn.textContent===activeCat);
  });
}

function renderGrid(){
  const q = search.value.trim().toLowerCase();
  const items = EMOJIS.filter(e=>{
    if(activeCat && e.cat!==activeCat) return false;
    if(!q) return true;
    return e.name.includes(q) || e.keywords.some(k=>k.includes(q)) || e.char.includes(q);
  });
  grid.innerHTML='';
  if(items.length===0){ grid.innerHTML='<div style="padding:12px;color:#777">No results</div>'; return; }
  items.forEach(e=>{
    const div = document.createElement('div');
    div.className='emoji-item';
    div.textContent=e.char;
    div.title=e.name;
    div.onclick=()=> handleInsert(e.char);
    grid.appendChild(div);
  });
}

function addRecent(ch){ recent = recent.filter(x=>x!==ch); recent.unshift(ch); if(recent.length>MAX_RECENT) recent.pop(); renderRecent(); }
function renderRecent(){
  recentRow.innerHTML=''; if(recent.length===0) return;
  recent.forEach(ch=>{
    const btn = document.createElement('button');
    btn.className='cat-btn';
    btn.textContent=ch;
    btn.onclick=()=> handleInsert(ch);
    recentRow.appendChild(btn);
  });
}

function handleInsert(ch){
  const el = inputEl;
  const start = el.selectionStart||0;
  const end = el.selectionEnd||0;
  el.value = el.value.slice(0,start)+ch+el.value.slice(end);
  const pos = start+ch.length;
  el.setSelectionRange(pos,pos);
  addRecent(ch);
  el.focus();
}

toggleBtn.onclick=(e)=>{ e.stopPropagation(); togglePanel(); }
document.getElementById('closePanel').onclick=(e)=>{ e.stopPropagation(); closePanelFn(); }
panel.onclick=(e)=>{ e.stopPropagation(); }
document.addEventListener('click',()=>closePanelFn());
search.addEventListener('input', renderGrid);

renderCats();
renderGrid();

  </script>
</body>
</html>
